<head>
	<title>Mandelbrot Set</title>
</head>

<body style="font-family: arial; overflow: hidden">
<div style="width: 800px; height: 200px">
	Granularity (resolution): <input type="number" id="res" min="1" max="850" step="1" value="100">/850<br>
	Iterations (precision): <input type="number" id="iters" min="1" step="1" value="8"><br><br>
	
	Coordinates: <input type="number" id="posRe" value="0" style="width: 100px"> + <input type="number" id="posIm" value="0" style="width: 100px">i<br>
	Scale: <input type="number" id="posScale" value="2" min="0" style="width: 100px"><br><br>
	
	Color each iteration: <input type="checkbox" id="color" checked><br><br><br>
	
	
	<button id="drawButton">Draw</button>
</div>

<div width=850px height=850px style="overflow: hidden; display: inline-block">
<canvas id="canvas" width="800" height="800" style="border: 3px solid black"></canvas>
</div>

</body>

<script>
var res = document.getElementById("res");
var iters = document.getElementById("iters");
var colorIters = document.getElementById("color");
var posRe = document.getElementById("posRe");
var posIm = document.getElementById("posIm");
var posScale = document.getElementById("posScale");

function getPreset()
{
	let settings = (new URL(window.location.href)).searchParams;
	
	let setCoords = (settings.get("coords") || "0").split(/(-*\d.*i*(?=-| ))/);
	let setScale = parseFloat(settings.get("scale") || 2);
	let setRes = parseInt(settings.get("res") || 100);
	let setIters = parseInt(settings.get("iters") || 6);
	let setAutogen = settings.has("autogen");
	let setDontColor = settings.has("nocolor") || settings.has("nocolour");

	let setCoordX = 0; let setCoordY = 0;

	for(let i of setCoords)
	{
		if(i.includes('i'))
			if(i == 'i' || i == " i")
				setCoordY++;
			else if(i == "-i" || i == " -i")
				setCoordY--;
			else
				setCoordY+=parseFloat(i);
		else
			if(i) setCoordX+=parseFloat(i);
	}
	
	res.value = setRes;
	iters.value = setIters;
	colorIters.checked = !setDontColor;
	posRe.value = setCoordX;
	posIm.value = setCoordY;
	posScale.value = setScale;
	
	
	return { x: setCoordX, y: setCoordY, scale: setScale, res: setRes, iters: setIters, autogen: setAutogen, color: !setDontColor };

}

var parameters = getPreset();

document.getElementById("drawButton").addEventListener("click", drawMandelbrot);

res.addEventListener("input", function() { parameters.res = this.value || 100; } );
iters.addEventListener("input", function() { parameters.iters = this.value || 6; } );
posScale.addEventListener("input", function() { parameters.scale = this.value || 2; } );
colorIters.addEventListener("input", function() { parameters.color = this.checked; } );
posRe.addEventListener("input", function() { parameters.x = this.value || 0; } );
posIm.addEventListener("input", function() { parameters.y = this.value || 0; } );

function updateURL()
{
	// Here we put all the custom parameters straight into the URL for easy access. It's also a great failsafe if you accidentally close the page.
	window.history.replaceState({ "pageTitle": "Mandelbrot Set" }, "", (parameters.x==0&&parameters.y==0&&parameters.scale==2&&parameters.res==100&&parameters.iters==6&&parameters.color)?"?":"?autogen"
	+((parameters.res==100)?"":			"&res="+parameters.res)
	+((parameters.iters==6)?"":			"&iters="+parameters.iters)
	+((parameters.x==0 && parameters.y==0)?"":	"&coords="+((parameters.x==0)?"":parameters.x)+
		(
			(parameters.y==0)?"":(
				(parameters.y<0)?(
					(parameters.y==-1)?"-i":parameters.y + "i"
				):(
					((parameters.x==0)?"":"+") + ((parameters.y==1)?"i":parameters.y + "i")
				)
			)
		)
	)
	+((parameters.scale==2)?"":			"&scale="+parameters.scale)
	+((parameters.color)?"":			"&nocolor")
	);
}


var rect = { xMin: 0, yMin: 0, xMax: 0, yMax: 0, width: 0, height: 0 };

var canvas = document.getElementById("canvas");
canvas.addEventListener("click", shiftCoords);
canvas.addEventListener("wheel", shiftScale);
var ctx = canvas.getContext("2d");
var wid = canvas.width;
var hei = canvas.height;
var iterations, pointSize, pixelSize, iterationsSquared = 0;
var canvasSize = wid / rect.width;
var colorIterations = true;
ctx.fillStyle = "black";



var palette = createPalette();



function iterateF(x, y) // f(z)=z²+c, f(f(f(f(f(...f(0)))))...) < ∞
{
	let num = { a: 0, b: 0 };
	for(let i = 0; i < iterations; i++)
	{
		num = { a: num.a**2 - num.b**2 + x, b: 2 * num.a * num.b + y }; // This is equivalent to z=z²+c, where z and c are complex numbers.
		if(num.a**2+num.b**2 > iterationsSquared)	// It doesn't have to be iterationsSquared. In theory, it should be infinity, but since we're only calculating a finite amount of iterations, this number is mostly arbitrary.
			return i;
	}
	return -1;
}

function clear()
{
	ctx.clearRect(0, 0, wid, hei);
}

function drawMandelbrot()
{
	// Let's prepare the set's environment.
	parameters.autogen = false;
	pointSize = parameters.scale / parameters.res;
	iterations = Number(parameters.iters);
	colorIterations = parameters.color;
	let pointColor = 0;
	
	let center = { x: Number(posRe.value), y: -Number(posIm.value) };
	rect.width = rect.height = parameters.scale * 2;
	rect.xMin = center.x - rect.width / 2;
	rect.xMax = center.x + rect.width / 2;
	rect.yMin = center.y - rect.height / 2;
	rect.yMax = center.y + rect.height / 2;
	canvasSize = canvas.width / rect.width;
	
	clear();
	
	pixelSize = pointSize * canvasSize;
	iterationsSquared = iterations**2;
	
	
	// Now, let's draw it!
	for(let x = rect.xMin; x < rect.xMax; x+=pointSize)
		for(let y = rect.yMin; y < rect.yMax; y+=pointSize)
		{
			pointColor = iterateF(x, y);
			if(colorIterations || pointColor == -1)
				drawPixel(x, y, pointColor);
		}
	
	
	updateURL();
}

function drawPixel(x, y, iteration)
{
	// Do you see the pixels 'melting' when you use many iterations and zoom in very deep? I don't know what causes them. If you have any idea, I'd love to know.
	ctx.fillStyle = (iteration<0) ? "#000000" : palette[iteration%palette.length];
	ctx.fillRect((x - rect.xMin) * canvasSize, (y - rect.yMin) * canvasSize, pixelSize, pixelSize);
}

function createPalette()
{
	// I initially generated a color for every pixel before I realized it's much more efficient to have a preset palette with a color for each iteration.
	let palette = [];
	for(let i = 0; i < 63; i++)
		palette.push("#"+Math.round(
			2**24*i/63
		).toString(16)
		);
	return palette;
	
}

function shiftCoords(e, multiplier = 1)
{
	// This is for navigation around the complex plane.
	let x = e.offsetX / canvasSize - rect.width / 2;
	let y = (canvas.height - e.offsetY) / canvasSize - rect.height / 2;
	
	parameters.x += x * multiplier;
	parameters.y += y * multiplier;
	
	posRe.value=parameters.x;
	posIm.value=parameters.y;
	
	drawMandelbrot();
}

function shiftScale(e)
{
	// And this is to zoom in on the complex plane, as well as move about it slightly.
	parameters.scale *= 2**(-e.wheelDelta / Math.abs(e.wheelDelta));
	posScale.value = parameters.scale;
	
	shiftCoords(e, 0.5);
}


if(parameters.autogen)
	drawMandelbrot();
</script>
